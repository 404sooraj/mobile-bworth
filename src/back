import React, { useState, useEffect } from 'react';
import {
  Image,
  Text,
  View,
  ToastAndroid,
  TouchableOpacity,
  PermissionsAndroid,
} from 'react-native';
import { launchImageLibrary } from 'react-native-image-picker'; // Import the image picker
import Button from '../../components/Button';
import storage from '../utils/storageService';
import Api from '../../redux/Api';
import RenderInputField from '../common/renderInputField';
import Loading from '../../custom';
import { widthPrecent as wp, heightPercent as hp } from '../utils/responsive';

export default Settings = ({ navigation, route }) => {
  const data = route?.params?.data ?? [];
  const [loading, setLoading] = useState(false);
  const [imageUri, setImageUri] = useState(''); // State to store selected image URI
  const [inputs, setInputs] = useState({
    firstName: '',
    lastName: '',
    email: '',
    phone: '',
    address: '',
  });
  const [defaulInputS, setDefaultInput] = useState({
    phone: '',
    address: '',
  });

  useEffect(() => {
    gesome();
  }, []);

  const gesome = async () => {
    const phone = await storage.getItem(storage.PHONE);
    const address = await storage.getItem(storage.Address);
    setDefaultInput({
      phone: phone.toString() ?? '',
      address: address ?? '',
    });
  };

  useEffect(() => {
    setInputs((prev) => ({
      ...prev,
      firstName: data?.firstName,
      lastName: data?.lastName,
      email: data?.emailAddress,
      phone: data?.phoneNumber ? data?.phoneNumber.toString() : defaulInputS.phone,
      address: data?.address ? data?.address : defaulInputS.address,
    }));
  }, [defaulInputS]);

  // Function to pick image from gallery
  const handlePickImage = async () => {
    try {
      const result = await launchImageLibrary({
        mediaType: 'photo',
        includeBase64: false,
      });

      if (result?.assets && result.assets.length > 0) {
        const selectedImage = result.assets[0];
        setImageUri(selectedImage.uri); // Update image URI to state
      } else {
        ToastAndroid.show('No image selected', ToastAndroid.SHORT);
      }
    } catch (error) {
      console.error('Error picking image:', error);
      ToastAndroid.show('Error picking image', ToastAndroid.SHORT);
    }
  };

  const handleOnChange = (key, value) => {
    setInputs((prev) => ({ ...prev, [key]: value }));
  };

  const validateInputs = () => {
    const { firstName, lastName, email, phone, address } = inputs;

    if (firstName.trim() === '') {
      ToastAndroid.show('First name is required', ToastAndroid.SHORT);
      return false;
    }

    if (lastName.trim() === '') {
      ToastAndroid.show('Last name is required', ToastAndroid.SHORT);
      return false;
    }

    if (!email.match(/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/)) {
      ToastAndroid.show('Invalid email address', ToastAndroid.SHORT);
      return false;
    }
    if (!inputs.phone) {
      ToastAndroid.show('Phone number is required', ToastAndroid.SHORT);
      return false;
    } else if (!/^\d{10}$/.test(inputs.phone)) {
      ToastAndroid.show('Phone number should be 10 digits', ToastAndroid.SHORT);
      return false;
    }
    return true;
  };

  const handleOnSubmit = async () => {
    try {
      const id = await storage.getItem(storage.use_id);
      if (validateInputs()) {
        setLoading(true);
        const sendApi = {
          loginId: id,
          profileImage: imageUri || 'https://defaultimageurl.com', // Use the selected image URI or a default image URL
          firstName: inputs.firstName,
          lastName: inputs.lastName,
          emailAddress: inputs.email,
          phoneNumber: inputs.phone,
          address: inputs.address,
        };
        const endPoint = 'addProfileSetting';
        const res = await Api.postRequest(endPoint, sendApi);

        if (res.data) {
          ToastAndroid.show('Profile Updated', ToastAndroid.SHORT);
          navigation.goBack();
        } else {
          ToastAndroid.show('Failed to update profile', ToastAndroid.SHORT);
        }
        setLoading(false);
      }
    } catch (err) {
      console.log(err);
      setLoading(false);
      ToastAndroid.show('Failed to update profile', ToastAndroid.SHORT);
    }
  };

  return (
    <View style={{ flex: 1 }}>
      {loading && <Loading />}
      <View style={{ flex: 1, backgroundColor: '#F7F7F7', paddingHorizontal: 20 }}>
        <Text style={{ fontSize: 24, fontWeight: 'bold', marginBottom: 20, color: '#000000' }}>
          Profile Settings
        </Text>

        <View style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 30 }}>
          <Image
            source={{ uri: imageUri || 'https://defaultimageurl.com' }} // Show selected image or default
            resizeMode="contain"
            style={{
              width: hp(13),
              height: hp(13),
              marginRight: 20,
              borderRadius: hp(7.5),
              borderColor: '#BABABA',
              borderWidth: 1,
              marginLeft: '-2%',
            }}
          />

          <View style={{ flexDirection: 'column', marginTop: '5%', flex: 1 }}>
            <Button
              background={true}
              style={{
                backgroundColor: '#1DD8E0',
                borderRadius: 8,
                paddingVertical: 10,
                marginBottom: 10,
                borderColor: '#BABABA',
                borderWidth: 1,
                alignItems: 'center',
                justifyContent: 'center',
                width: wp(55),
                height: hp(5.1),
              }}
              title={'Change Photo'}
              textStyle={{ color: '#fff', fontSize: 14, fontWeight: 'bold' }}
              onPress={handlePickImage} // Trigger image picker
            />
            <TouchableOpacity
              style={{
                borderRadius: 8,
                paddingVertical: 10,
                marginBottom: 10,
                borderColor: '#BABABA',
                borderWidth: 1,
                alignItems: 'center',
                justifyContent: 'center',
                width: wp(55),
                height: hp(5.1),
              }}>
              <Text style={{ color: '#000000', fontSize: 14, fontWeight: 'bold' }}>Delete Photo</Text>
            </TouchableOpacity>
          </View>
        </View>

        <RenderInputField
          label="First Name"
          value={inputs.firstName}
          onChangeText={(txt) => handleOnChange('firstName', txt)}
        />
        <RenderInputField
          label="Last Name"
          value={inputs.lastName}
          onChangeText={(txt) => handleOnChange('lastName', txt)}
        />
        <RenderInputField
          label="Email"
          value={inputs.email}
          onChangeText={(txt) => handleOnChange('email', txt)}
          keyboardType={'email'}
        />
        <RenderInputField
          label="Phone No."
          value={inputs.phone}
          onChangeText={(txt) => handleOnChange('phone', txt)}
          keyboardType={'numeric'}
          maxLength={10}
        />
        <RenderInputField
          label="Address"
          value={inputs.address}
          onChangeText={(txt) => handleOnChange('address', txt)}
        />

        <Button
          background={true}
          onPress={handleOnSubmit}
          style={{ width: wp(90), borderRadius: 5, marginTop: '15%' }}
          title={'Save'}
        />
      </View>
    </View>
  );
};
